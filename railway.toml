# ========================================
# Railway Configuration
# ========================================
# Defines services for Railway deployment
# Each service is a separate container
# ========================================

[build]
builder = "DOCKERFILE"
dockerfilePath = "Dockerfile.worker"

[[services]]
# ========================================
# Web Service (Next.js)
# ========================================
# Deployed to Vercel, not Railway
# (Railway only handles workers + database)
# ========================================
# [services.web]
# name = "gamma-klone-web"
# dockerfile = "Dockerfile.web"
# healthcheckPath = "/api/health"
# healthcheckTimeout = 10
# restartPolicyType = "ON_FAILURE"
# restartPolicyMaxRetries = 3

# [services.web.deploy]
# numReplicas = 1
# sleepApplication = false

# [services.web.env]
# PORT = "3000"
# NODE_ENV = "production"

[[services]]
# ========================================
# Worker Service (BullMQ)
# ========================================
# Runs generation + export + extraction workers
# Requires Playwright/Chromium for PDF export
# ========================================
[services.worker]
name = "gamma-klone-worker"
dockerfile = "Dockerfile.worker"
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 5

[services.worker.deploy]
numReplicas = 1
sleepApplication = false

[services.worker.healthcheck]
# Workers don't expose HTTP, so no healthcheck path
# Railway will use process health checks instead

[services.worker.env]
NODE_ENV = "production"
WORKER_CONCURRENCY = "2"

# Database and Redis are connected via Railway's service references
# These will be auto-populated by Railway:
# - DATABASE_URL (from Postgres service)
# - REDIS_URL (from Redis service)

[[services]]
# ========================================
# PostgreSQL Database
# ========================================
# Railway managed Postgres 16
# Auto-backups + connection pooling
# ========================================
[services.postgres]
name = "gamma-klone-postgres"
image = "postgres:16-alpine"

[services.postgres.volumes]
# Persistent volume for database data
data = "/var/lib/postgresql/data"

[services.postgres.env]
POSTGRES_USER = "gamma"
POSTGRES_DB = "gamma_klone"
# POSTGRES_PASSWORD is auto-generated by Railway

[[services]]
# ========================================
# Redis Cache & Queue
# ========================================
# Railway managed Redis 7
# Used for BullMQ job queues
# ========================================
[services.redis]
name = "gamma-klone-redis"
image = "redis:7-alpine"

[services.redis.volumes]
# Persistent volume for Redis data
data = "/data"

[services.redis.healthcheck]
command = ["redis-cli", "ping"]
interval = 10
timeout = 5
retries = 5

# ========================================
# Environment Variables (Shared)
# ========================================
# These must be set in Railway dashboard
# for EACH service that needs them:
# ========================================
# Required for ALL services:
# - DATABASE_URL (auto from postgres service)
# - REDIS_URL (auto from redis service)
# - OPENAI_API_KEY (manual)
# - GEMINI_API_KEY (manual)
# - NEXT_PUBLIC_SUPABASE_URL (manual)
# - NEXT_PUBLIC_SUPABASE_ANON_KEY (manual)
# - SUPABASE_SERVICE_ROLE_KEY (manual)
# - S3_ENDPOINT (manual - Railway Object Storage or external)
# - S3_ACCESS_KEY (manual)
# - S3_SECRET_KEY (manual)
# - S3_BUCKET (manual)
# - APP_SECRET (manual - generate random string)
# ========================================
